import e from"react";import{polyfill as t}from"react-lifecycles-compat";import n from"prop-types";import{select as o,svg as r,behavior as a,event as i,layout as s,csv as l,json as c}from"d3";import u from"clone";import p from"deep-equal";import d from"uuid";import{TransitionGroup as h}from"react-transition-group";function f(){return(f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}function m(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var y=function(t){return t.transitionDuration>0?e.createElement(h,{component:t.component,className:t.className,transform:t.transform},t.children):e.createElement("g",{className:t.className,transform:t.transform},t.children)};y.defaultProps={component:"g"},y.propTypes={transitionDuration:n.number.isRequired,component:n.string,className:n.string.isRequired,transform:n.string.isRequired,children:n.array.isRequired};var b=function(t){function n(){return t.apply(this,arguments)||this}return m(n,t),n.prototype.render=function(){var t=this.props,n=t.nodeStyle,o=t.textLayout,r=t.attributes;return e.createElement("g",null,e.createElement("text",{className:"nodeNameBase",style:n.name,textAnchor:o.textAnchor,x:o.x,y:o.y,transform:o.transform,dy:".35em"},t.name),e.createElement("text",{className:"nodeAttributesBase",y:o.y+10,textAnchor:o.textAnchor,transform:o.transform,style:n.attributes},r&&Object.keys(r).map(function(t){return e.createElement("tspan",{x:o.x,dy:"1.2em",key:d.v4()},t,": ",r[t])})))},n}(e.PureComponent);b.defaultProps={attributes:void 0},b.propTypes={name:n.string.isRequired,attributes:n.object,textLayout:n.object.isRequired,nodeStyle:n.object.isRequired};var v=function(t){function n(){return t.apply(this,arguments)||this}return m(n,t),n.prototype.render=function(){var t=this.props,n=t.nodeData,o=t.nodeSize,r=t.render;return e.createElement("foreignObject",f({width:o.x-24,height:o.y-24},t.foreignObjectWrapper),e.cloneElement(r,{nodeData:n}))},n}(e.PureComponent);v.defaultProps={foreignObjectWrapper:{}},v.propTypes={render:n.oneOfType([n.element,n.node]).isRequired,nodeData:n.object.isRequired,nodeSize:n.shape({x:n.number,y:n.number}).isRequired,foreignObjectWrapper:n.object};var g=function(t){function n(){for(var n,o=arguments.length,r=new Array(o),a=0;a<o;a++)r[a]=arguments[a];return(n=t.call.apply(t,[this].concat(r))||this).state={transform:n.setTransform(n.props.nodeData,n.props.orientation,!0),initialStyle:{opacity:0}},n.shouldNodeTransform=function(e,t){return t.subscriptions!==e.subscriptions||t.nodeData.x!==e.nodeData.x||t.nodeData.y!==e.nodeData.y||t.orientation!==e.orientation},n.renderNodeElement=function(t){var o=n.props,r=o.circleRadius,a=o.nodeSvgShape;return r?e.createElement("circle",{r:r,style:t.circle}):"none"===a.shape?null:e.createElement(a.shape,f({},t.circle,a.shapeProps))},n.handleOnClick=function(e){n.props.onClick(n.props.nodeData.id,e)},n.handleOnMouseOver=function(e){n.props.onMouseOver(n.props.nodeData.id,e)},n.handleOnMouseOut=function(e){n.props.onMouseOut(n.props.nodeData.id,e)},n}m(n,t);var r=n.prototype;return r.componentDidMount=function(){this.commitTransform()},r.componentDidUpdate=function(){this.commitTransform()},r.shouldComponentUpdate=function(e){return this.shouldNodeTransform(this.props,e)},r.setTransform=function(e,t,n){void 0===n&&(n=!1);var o=e.x,r=e.y,a=e.parent;if(n){var i="object"==typeof a,s=i?a.x:0,l=i?a.y:0;return"horizontal"===t?"translate("+l+","+s+")":"translate("+s+","+l+")"}return"horizontal"===t?"translate("+r+","+o+")":"translate("+o+","+r+")"},r.applyTransform=function(e,t,n,r){void 0===n&&(n=1),void 0===r&&(r=function(){}),0===t?(o(this.node).attr("transform",e).style("opacity",n),r()):o(this.node).transition().duration(t).attr("transform",e).style("opacity",n).each("end",r)},r.commitTransform=function(){var e=this.props,t=e.transitionDuration,n=this.setTransform(e.nodeData,e.orientation);this.applyTransform(n,t)},r.componentWillLeave=function(e){var t=this.props,n=t.transitionDuration,o=this.setTransform(t.nodeData,t.orientation,!0);this.applyTransform(o,n,0,e)},r.render=function(){var t=this,n=this.props,o=n.nodeData,r=n.nodeSize,a=n.nodeLabelComponent,i=n.allowForeignObjects,s=n.styles,l=f({},o._children?s.node:s.leafNode);return e.createElement("g",{id:o.id,ref:function(e){t.node=e},style:this.state.initialStyle,className:o._children?"nodeBase":"leafNodeBase",transform:this.state.transform,onClick:this.handleOnClick,onMouseOver:this.handleOnMouseOver,onMouseOut:this.handleOnMouseOut},this.renderNodeElement(l),i&&a?e.createElement(v,f({nodeData:o,nodeSize:r},a)):e.createElement(b,f({},this.props,{nodeStyle:l})))},n}(e.Component);g.defaultProps={nodeLabelComponent:null,name:"",attributes:void 0,circleRadius:void 0,styles:{node:{circle:{},name:{},attributes:{}},leafNode:{circle:{},name:{},attributes:{}}}},g.propTypes={nodeData:n.object.isRequired,nodeSvgShape:n.object.isRequired,nodeLabelComponent:n.object,nodeSize:n.object.isRequired,orientation:n.oneOf(["horizontal","vertical"]).isRequired,transitionDuration:n.number.isRequired,onClick:n.func.isRequired,onMouseOver:n.func.isRequired,onMouseOut:n.func.isRequired,name:n.string,attributes:n.object,textLayout:n.object.isRequired,subscriptions:n.object.isRequired,allowForeignObjects:n.bool.isRequired,circleRadius:n.number,styles:n.object};var O=function(t){function n(){for(var e,n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(e=t.call.apply(t,[this].concat(o))||this).state={initialStyle:{opacity:0}},e.handleOnClick=function(t){e.props.onClick(e.props.linkData.source,e.props.linkData.target,t)},e.handleOnMouseOver=function(t){e.props.onMouseOver(e.props.linkData.source,e.props.linkData.target,t)},e.handleOnMouseOut=function(t){e.props.onMouseOut(e.props.linkData.source,e.props.linkData.target,t)},e}m(n,t);var a=n.prototype;return a.componentDidMount=function(){this.applyOpacity(1,this.props.transitionDuration)},a.componentWillLeave=function(e){this.applyOpacity(0,this.props.transitionDuration,e)},a.applyOpacity=function(e,t,n){void 0===n&&(n=function(){}),0===t?(o(this.link).style("opacity",e),n()):o(this.link).transition().duration(t).style("opacity",e).each("end",n)},a.drawStepPath=function(e,t){var n=e.source,o=e.target,r=o.y-n.y;return"horizontal"===t?"M"+n.y+","+n.x+" H"+(n.y+r/2)+" V"+o.x+" H"+o.y:"M"+n.x+","+n.y+" V"+(n.y+r/2)+" H"+o.x+" V"+o.y},a.drawDiagonalPath=function(e,t){return r.diagonal().projection(function(e){return"horizontal"===t?[e.y,e.x]:[e.x,e.y]})(e)},a.drawStraightPath=function(e,t){var n=r.line().interpolate("basis").x(function(e){return e.x}).y(function(e){return e.y}),o=[{x:e.source.x,y:e.source.y},{x:e.target.x,y:e.target.y}];return"horizontal"===t&&(o=[{x:e.source.y,y:e.source.x},{x:e.target.y,y:e.target.x}]),n(o)},a.drawElbowPath=function(e,t){return"horizontal"===t?"M"+e.source.y+","+e.source.x+"V"+e.target.x+"H"+e.target.y:"M"+e.source.x+","+e.source.y+"V"+e.target.y+"H"+e.target.x},a.drawPath=function(){var e=this.props,t=e.linkData,n=e.orientation,o=e.pathFunc;return"function"==typeof o?o(t,n):"elbow"===o?this.drawElbowPath(t,n):"straight"===o?this.drawStraightPath(t,n):"step"===o?this.drawStepPath(t,n):this.drawDiagonalPath(t,n)},a.render=function(){var t=this;return e.createElement("path",{ref:function(e){t.link=e},style:f({},this.state.initialStyle,this.props.styles),className:"linkBase",d:this.drawPath(),onClick:this.handleOnClick,onMouseOver:this.handleOnMouseOver,onMouseOut:this.handleOnMouseOut,"data-source-id":this.props.linkData.source.id,"data-target-id":this.props.linkData.target.id})},n}(e.PureComponent);O.defaultProps={styles:{}},O.propTypes={linkData:n.object.isRequired,orientation:n.oneOf(["horizontal","vertical"]).isRequired,pathFunc:n.oneOfType([n.oneOf(["diagonal","elbow","straight","step"]),n.func]).isRequired,transitionDuration:n.number.isRequired,onClick:n.func.isRequired,onMouseOver:n.func.isRequired,onMouseOut:n.func.isRequired,styles:n.object};var x=function(t){function n(){for(var e,o=arguments.length,r=new Array(o),a=0;a<o;a++)r[a]=arguments[a];return(e=t.call.apply(t,[this].concat(r))||this).state={dataRef:e.props.data,data:n.assignInternalProperties(u(e.props.data)),d3:n.calculateD3Geometry(e.props),rd3tSvgClassName:"_"+d.v4(),rd3tGClassName:"_"+d.v4()},e.internalState={initialRender:!0,targetNode:null,isTransitioning:!1},e.handleNodeToggle=function(t,o){var r=u(e.state.data),a=e.findNodesById(t,r,[])[0];o.persist(),e.props.collapsible&&!e.state.isTransitioning?(a._collapsed?(n.expandNode(a),e.props.shouldCollapseNeighborNodes&&e.collapseNeighborNodes(a,r)):n.collapseNode(a),e.setState({data:r,isTransitioning:!0},function(){return e.handleOnClickCb(a,o)}),setTimeout(function(){return e.setState({isTransitioning:!1})},e.props.transitionDuration+10),e.internalState.targetNode=a):e.handleOnClickCb(a,o)},e.handleOnClickCb=function(t,n){var o=e.props.onClick;o&&"function"==typeof o&&o(u(t),n)},e.handleOnLinkClickCb=function(t,n,o){var r=e.props.onLinkClick;r&&"function"==typeof r&&(o.persist(),r(u(t),u(n),o))},e.handleOnMouseOverCb=function(t,n){var o=e.props.onMouseOver;if(o&&"function"==typeof o){var r=u(e.state.data),a=e.findNodesById(t,r,[])[0];n.persist(),o(u(a),n)}},e.handleOnLinkMouseOverCb=function(t,n,o){var r=e.props.onLinkMouseOver;r&&"function"==typeof r&&(o.persist(),r(u(t),u(n),o))},e.handleOnMouseOutCb=function(t,n){var o=e.props.onMouseOut;if(o&&"function"==typeof o){var r=u(e.state.data),a=e.findNodesById(t,r,[])[0];n.persist(),o(u(a),n)}},e.handleOnLinkMouseOutCb=function(t,n,o){var r=e.props.onLinkMouseOut;r&&"function"==typeof r&&(o.persist(),r(u(t),u(n),o))},e}m(n,t),n.getDerivedStateFromProps=function(e,t){var o=null;e.data!==t.dataRef&&(o={dataRef:e.data,data:n.assignInternalProperties(u(e.data))});var r=n.calculateD3Geometry(e);return p(r,t.d3)||((o=o||{}).d3=r),o};var r=n.prototype;return r.componentDidMount=function(){this.bindZoomListener(this.props),this.internalState.initialRender=!1},r.componentDidUpdate=function(e){p(this.props.translate,e.translate)&&p(this.props.scaleExtent,e.scaleExtent)&&this.props.zoom===e.zoom&&this.props.transitionDuration===e.transitionDuration||this.bindZoomListener(this.props),"function"==typeof this.props.onUpdate&&this.props.onUpdate({node:this.internalState.targetNode?u(this.internalState.targetNode):null,zoom:this.state.d3.scale,translate:this.state.d3.translate}),this.internalState.targetNode=null},r.setInitialTreeDepth=function(e,t){e.forEach(function(e){e._collapsed=e.depth>=t})},r.bindZoomListener=function(e){var t=this,n=e.zoomable,r=e.scaleExtent,s=e.translate,l=e.zoom,c=e.onUpdate,u=this.state,p=u.rd3tGClassName,d=o("."+u.rd3tSvgClassName),h=o("."+p);n&&d.call(a.zoom().scaleExtent([r.min,r.max]).on("zoom",function(){h.attr("transform","translate("+i.translate+") scale("+i.scale+")"),"function"==typeof c&&(c({node:null,zoom:i.scale,translate:{x:i.translate[0],y:i.translate[1]}}),t.state.d3.scale=i.scale,t.state.d3.translate={x:i.translate[0],y:i.translate[1]})}).scale(l).translate([s.x,s.y]))},n.assignInternalProperties=function(e){return(Array.isArray(e)?e:[e]).map(function(e){return e.id=d.v4(),void 0===e._collapsed&&(e._collapsed=!1),e.children&&e.children.length>0&&(e.children=n.assignInternalProperties(e.children),e._children=e.children),e})},r.findNodesById=function(e,t,n){var o=this;return n.length>0||(n=n.concat(t.filter(function(t){return t.id===e})),t.forEach(function(t){t._children&&t._children.length>0&&(n=o.findNodesById(e,t._children,n))})),n},r.findNodesAtDepth=function(e,t,n){var o=this;return n=n.concat(t.filter(function(t){return t.depth===e})),t.forEach(function(t){t._children&&t._children.length>0&&(n=o.findNodesAtDepth(e,t._children,n))}),n},n.collapseNode=function(e){e._collapsed=!0,e._children&&e._children.length>0&&e._children.forEach(function(e){n.collapseNode(e)})},n.expandNode=function(e){e._collapsed=!1},r.collapseNeighborNodes=function(e,t){this.findNodesAtDepth(e.depth,t,[]).filter(function(t){return t.id!==e.id}).forEach(function(e){return n.collapseNode(e)})},r.generateTree=function(){var e=this.props,t=e.initialDepth,n=e.useCollapseData,o=e.depthFactor,r=e.separation,a=e.nodeSize,i=e.orientation,l=s.tree().nodeSize("horizontal"===i?[a.y,a.x]:[a.x,a.y]).separation(function(e,t){return e.parent.id===t.parent.id?r.siblings:r.nonSiblings}).children(function(e){return e._collapsed?null:e._children}),c=this.state.data[0],u=l.nodes(c);return!1===n&&void 0!==t&&this.internalState.initialRender&&(this.setInitialTreeDepth(u,t),u=l.nodes(c)),o&&u.forEach(function(e){e.y=e.depth*o}),{nodes:u,links:l.links(u)}},n.calculateD3Geometry=function(e){return{translate:e.translate,scale:e.zoom>e.scaleExtent.max?e.scaleExtent.max:e.zoom<e.scaleExtent.min?e.scaleExtent.min:e.zoom}},r.render=function(){var t=this,n=this.generateTree(),o=n.nodes,r=n.links,a=this.state,i=a.rd3tSvgClassName,s=a.rd3tGClassName,l=this.props,c=l.nodeSvgShape,u=l.nodeLabelComponent,p=l.orientation,h=l.pathFunc,m=l.transitionDuration,b=l.zoomable,v=l.textLayout,x=l.nodeSize,D=l.circleRadius,k=l.allowForeignObjects,C=l.styles,N=this.state.d3,S=N.translate,M=N.scale,R=f({},x,l.separation,{depthFactor:l.depthFactor,initialDepth:l.initialDepth});return e.createElement("div",{className:"rd3t-tree-container "+(b?"rd3t-grabbable":void 0)},e.createElement("svg",{className:i,width:"100%",height:"100%"},e.createElement(y,{transitionDuration:m,component:"g",className:s,transform:"translate("+S.x+","+S.y+") scale("+M+")"},r.map(function(n){return e.createElement(O,{key:d.v4(),orientation:p,pathFunc:h,linkData:n,onClick:t.handleOnLinkClickCb,onMouseOver:t.handleOnLinkMouseOverCb,onMouseOut:t.handleOnLinkMouseOutCb,transitionDuration:m,styles:C.links})}),o.map(function(n){return e.createElement(g,{key:n.id,nodeSvgShape:f({},c,n.nodeSvgShape),nodeLabelComponent:u,nodeSize:x,orientation:p,transitionDuration:m,nodeData:n,name:n.name,attributes:n.attributes,onClick:t.handleNodeToggle,onMouseOver:t.handleOnMouseOverCb,onMouseOut:t.handleOnMouseOutCb,textLayout:n.textLayout||v,circleRadius:D,subscriptions:R,allowForeignObjects:k,styles:C.nodes})}))))},n}(e.Component);function D(e,t){var n={};return e.forEach(function(e){if(t){var o={};t.forEach(function(t){o[t]=e[t]}),e.attributes=o}var r;e.source=(n[r=e.parent]||(n[r]={name:r}),n[r]),e.target=function(e,t){return n[e]||(n[e]={name:e,attributes:t}),n[e]}(e.child,e.attributes);var a=e.source,i=e.target;a.id=d.v4(),i.id=d.v4(),i.parent=a.name||null,a._collapsed=i._collapsed=!1,a._children?a._children.push(i):a._children=[i]}),[e.filter(function(e){return!e.source.parent})[0].source]}x.defaultProps={nodeSvgShape:{shape:"circle",shapeProps:{r:10}},nodeLabelComponent:null,onClick:void 0,onMouseOver:void 0,onMouseOut:void 0,onLinkClick:void 0,onLinkMouseOver:void 0,onLinkMouseOut:void 0,onUpdate:void 0,orientation:"horizontal",translate:{x:0,y:0},pathFunc:"diagonal",transitionDuration:500,depthFactor:void 0,collapsible:!0,useCollapseData:!1,initialDepth:void 0,zoomable:!0,zoom:1,scaleExtent:{min:.1,max:1},nodeSize:{x:140,y:140},separation:{siblings:1,nonSiblings:2},textLayout:{textAnchor:"start",x:10,y:-10,transform:void 0},allowForeignObjects:!1,shouldCollapseNeighborNodes:!1,circleRadius:void 0,styles:{}},x.propTypes={data:n.oneOfType([n.array,n.object]).isRequired,nodeSvgShape:n.shape({shape:n.string,shapeProps:n.object}),nodeLabelComponent:n.object,onClick:n.func,onMouseOver:n.func,onMouseOut:n.func,onLinkClick:n.func,onLinkMouseOver:n.func,onLinkMouseOut:n.func,onUpdate:n.func,orientation:n.oneOf(["horizontal","vertical"]),translate:n.shape({x:n.number,y:n.number}),pathFunc:n.oneOfType([n.oneOf(["diagonal","elbow","straight","step"]),n.func]),transitionDuration:n.number,depthFactor:n.number,collapsible:n.bool,useCollapseData:n.bool,initialDepth:n.number,zoomable:n.bool,zoom:n.number,scaleExtent:n.shape({min:n.number,max:n.number}),nodeSize:n.shape({x:n.number,y:n.number}),separation:n.shape({siblings:n.number,nonSiblings:n.number}),textLayout:n.object,allowForeignObjects:n.bool,shouldCollapseNeighborNodes:n.bool,circleRadius:n.number,styles:n.shape({nodes:n.object,links:n.object})},t(x);var k={__proto__:null,default:{parseCSV:function(e,t){return new Promise(function(n,o){try{l(e,function(e){return n(D(e,t))})}catch(e){o(e)}})},parseJSON:function(e){return new Promise(function(t,n){try{c(e,function(e){return t([e])})}catch(e){n(e)}})},parseFlatJSON:function(e,t){return new Promise(function(n,o){try{c(e,function(e){return n(D(e,t))})}catch(e){o(e)}})},generateHierarchy:function(e){return D(e)}}};export{x as Tree,k as treeUtil};
//# sourceMappingURL=react-d3-tree.module.js.map

import e from"react";import{polyfill as t}from"react-lifecycles-compat";import n from"prop-types";import{select as o,svg as s,zoom as a,layout as i,csv as r,json as l}from"d3";import d from"clone";import c from"deep-equal";import p from"uuid";import{TransitionGroup as h}from"react-transition-group";function u(){return(u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}const m=t=>t.transitionDuration>0?e.createElement(h,{component:t.component,className:t.className,transform:t.transform},t.children):e.createElement("g",{className:t.className,transform:t.transform},t.children);m.defaultProps={component:"g"},m.propTypes={transitionDuration:n.number.isRequired,component:n.string,className:n.string.isRequired,transform:n.string.isRequired,children:n.array.isRequired};class y extends e.PureComponent{render(){const{name:t,nodeStyle:n,textLayout:o,attributes:s}=this.props;return e.createElement("g",null,e.createElement("text",{className:"nodeNameBase",style:n.name,textAnchor:o.textAnchor,x:o.x,y:o.y,transform:o.transform,dy:".35em"},t),e.createElement("text",{className:"nodeAttributesBase",y:o.y+10,textAnchor:o.textAnchor,transform:o.transform,style:n.attributes},s&&Object.keys(s).map(t=>e.createElement("tspan",{x:o.x,dy:"1.2em",key:p.v4()},t,": ",s[t]))))}}y.defaultProps={attributes:void 0},y.propTypes={name:n.string.isRequired,attributes:n.object,textLayout:n.object.isRequired,nodeStyle:n.object.isRequired};class f extends e.PureComponent{render(){const{nodeData:t,nodeSize:n,render:o,foreignObjectWrapper:s}=this.props;return e.createElement("foreignObject",u({width:n.x-24,height:n.y-24},s),e.cloneElement(o,{nodeData:t}))}}f.defaultProps={foreignObjectWrapper:{}},f.propTypes={render:n.oneOfType([n.element,n.node]).isRequired,nodeData:n.object.isRequired,nodeSize:n.shape({x:n.number,y:n.number}).isRequired,foreignObjectWrapper:n.object};class b extends e.Component{constructor(...t){super(...t),this.state={transform:this.setTransform(this.props.nodeData,this.props.orientation,!0),initialStyle:{opacity:0}},this.shouldNodeTransform=(e,t)=>t.subscriptions!==e.subscriptions||t.nodeData.x!==e.nodeData.x||t.nodeData.y!==e.nodeData.y||t.orientation!==e.orientation,this.renderNodeElement=t=>{const{circleRadius:n,nodeSvgShape:o}=this.props;return n?e.createElement("circle",{r:n,style:t.circle}):"none"===o.shape?null:e.createElement(o.shape,u({},t.circle,o.shapeProps))},this.handleOnClick=e=>{this.props.onClick(this.props.nodeData.id,e)},this.handleOnMouseOver=e=>{this.props.onMouseOver(this.props.nodeData.id,e)},this.handleOnMouseOut=e=>{this.props.onMouseOut(this.props.nodeData.id,e)}}componentDidMount(){this.commitTransform()}componentDidUpdate(){this.commitTransform()}shouldComponentUpdate(e){return this.shouldNodeTransform(this.props,e)}setTransform(e,t,n=!1){const{x:o,y:s,parent:a}=e;if(n){const e="object"==typeof a,n=e?a.x:0,o=e?a.y:0;return"horizontal"===t?`translate(${o},${n})`:`translate(${n},${o})`}return"horizontal"===t?`translate(${s},${o})`:`translate(${o},${s})`}applyTransform(e,t,n=1,s=(()=>{})){0===t?(o(this.node).attr("transform",e).style("opacity",n),s()):o(this.node).transition().duration(t).attr("transform",e).style("opacity",n).each("end",s)}commitTransform(){const{nodeData:e,orientation:t,transitionDuration:n}=this.props,o=this.setTransform(e,t);this.applyTransform(o,n)}componentWillLeave(e){const{nodeData:t,orientation:n,transitionDuration:o}=this.props,s=this.setTransform(t,n,!0);this.applyTransform(s,o,0,e)}render(){const{nodeData:t,nodeSize:n,nodeLabelComponent:o,allowForeignObjects:s,styles:a}=this.props,i=u({},t._children?a.node:a.leafNode);return e.createElement("g",{id:t.id,ref:e=>{this.node=e},style:this.state.initialStyle,className:t._children?"nodeBase":"leafNodeBase",transform:this.state.transform,onClick:this.handleOnClick,onMouseOver:this.handleOnMouseOver,onMouseOut:this.handleOnMouseOut},this.renderNodeElement(i),s&&o?e.createElement(f,u({nodeData:t,nodeSize:n},o)):e.createElement(y,u({},this.props,{nodeStyle:i})))}}b.defaultProps={nodeLabelComponent:null,name:"",attributes:void 0,circleRadius:void 0,styles:{node:{circle:{},name:{},attributes:{}},leafNode:{circle:{},name:{},attributes:{}}}},b.propTypes={nodeData:n.object.isRequired,nodeSvgShape:n.object.isRequired,nodeLabelComponent:n.object,nodeSize:n.object.isRequired,orientation:n.oneOf(["horizontal","vertical"]).isRequired,transitionDuration:n.number.isRequired,onClick:n.func.isRequired,onMouseOver:n.func.isRequired,onMouseOut:n.func.isRequired,name:n.string,attributes:n.object,textLayout:n.object.isRequired,subscriptions:n.object.isRequired,allowForeignObjects:n.bool.isRequired,circleRadius:n.number,styles:n.object};class g extends e.PureComponent{constructor(...e){super(...e),this.state={initialStyle:{opacity:0}},this.handleOnClick=e=>{this.props.onClick(this.props.linkData.source,this.props.linkData.target,e)},this.handleOnMouseOver=e=>{this.props.onMouseOver(this.props.linkData.source,this.props.linkData.target,e)},this.handleOnMouseOut=e=>{this.props.onMouseOut(this.props.linkData.source,this.props.linkData.target,e)}}componentDidMount(){this.applyOpacity(1,this.props.transitionDuration)}componentWillLeave(e){this.applyOpacity(0,this.props.transitionDuration,e)}applyOpacity(e,t,n=(()=>{})){0===t?(o(this.link).style("opacity",e),n()):o(this.link).transition().duration(t).style("opacity",e).each("end",n)}drawStepPath(e,t){const{source:n,target:o}=e,s=o.y-n.y;return"horizontal"===t?`M${n.y},${n.x} H${n.y+s/2} V${o.x} H${o.y}`:`M${n.x},${n.y} V${n.y+s/2} H${o.x} V${o.y}`}drawDiagonalPath(e,t){return s.diagonal().projection(e=>"horizontal"===t?[e.y,e.x]:[e.x,e.y])(e)}drawStraightPath(e,t){const n=s.line().interpolate("basis").x(e=>e.x).y(e=>e.y);let o=[{x:e.source.x,y:e.source.y},{x:e.target.x,y:e.target.y}];return"horizontal"===t&&(o=[{x:e.source.y,y:e.source.x},{x:e.target.y,y:e.target.x}]),n(o)}drawElbowPath(e,t){return"horizontal"===t?`M${e.source.y},${e.source.x}V${e.target.x}H${e.target.y}`:`M${e.source.x},${e.source.y}V${e.target.y}H${e.target.x}`}drawPath(){const{linkData:e,orientation:t,pathFunc:n}=this.props;return"function"==typeof n?n(e,t):"elbow"===n?this.drawElbowPath(e,t):"straight"===n?this.drawStraightPath(e,t):"step"===n?this.drawStepPath(e,t):this.drawDiagonalPath(e,t)}render(){const{styles:t}=this.props;return e.createElement("path",{ref:e=>{this.link=e},style:u({},this.state.initialStyle,t),className:"linkBase",d:this.drawPath(),onClick:this.handleOnClick,onMouseOver:this.handleOnMouseOver,onMouseOut:this.handleOnMouseOut,"data-source-id":this.props.linkData.source.id,"data-target-id":this.props.linkData.target.id})}}g.defaultProps={styles:{}},g.propTypes={linkData:n.object.isRequired,orientation:n.oneOf(["horizontal","vertical"]).isRequired,pathFunc:n.oneOfType([n.oneOf(["diagonal","elbow","straight","step"]),n.func]).isRequired,transitionDuration:n.number.isRequired,onClick:n.func.isRequired,onMouseOver:n.func.isRequired,onMouseOut:n.func.isRequired,styles:n.object};class O extends e.Component{constructor(...e){super(...e),this.state={dataRef:this.props.data,data:O.assignInternalProperties(d(this.props.data)),d3:O.calculateD3Geometry(this.props),rd3tSvgClassName:"_"+p.v4(),rd3tGClassName:"_"+p.v4()},this.internalState={initialRender:!0,targetNode:null,isTransitioning:!1},this.handleNodeToggle=(e,t)=>{const n=d(this.state.data),o=this.findNodesById(e,n,[])[0];t.persist(),this.props.collapsible&&!this.state.isTransitioning?(o._collapsed?(O.expandNode(o),this.props.shouldCollapseNeighborNodes&&this.collapseNeighborNodes(o,n)):O.collapseNode(o),this.setState({data:n,isTransitioning:!0},()=>this.handleOnClickCb(o,t)),setTimeout(()=>this.setState({isTransitioning:!1}),this.props.transitionDuration+10),this.internalState.targetNode=o):this.handleOnClickCb(o,t)},this.handleOnClickCb=(e,t)=>{const{onClick:n}=this.props;n&&"function"==typeof n&&n(d(e),t)},this.handleOnLinkClickCb=(e,t,n)=>{const{onLinkClick:o}=this.props;o&&"function"==typeof o&&(n.persist(),o(d(e),d(t),n))},this.handleOnMouseOverCb=(e,t)=>{const{onMouseOver:n}=this.props;if(n&&"function"==typeof n){const o=d(this.state.data),s=this.findNodesById(e,o,[])[0];t.persist(),n(d(s),t)}},this.handleOnLinkMouseOverCb=(e,t,n)=>{const{onLinkMouseOver:o}=this.props;o&&"function"==typeof o&&(n.persist(),o(d(e),d(t),n))},this.handleOnMouseOutCb=(e,t)=>{const{onMouseOut:n}=this.props;if(n&&"function"==typeof n){const o=d(this.state.data),s=this.findNodesById(e,o,[])[0];t.persist(),n(d(s),t)}},this.handleOnLinkMouseOutCb=(e,t,n)=>{const{onLinkMouseOut:o}=this.props;o&&"function"==typeof o&&(n.persist(),o(d(e),d(t),n))}}static getDerivedStateFromProps(e,t){let n=null;e.data!==t.dataRef&&(n={dataRef:e.data,data:O.assignInternalProperties(d(e.data))});const o=O.calculateD3Geometry(e);return c(o,t.d3)||(n=n||{},n.d3=o),n}componentDidMount(){this.bindZoomListener(this.props),this.internalState.initialRender=!1}componentDidUpdate(e){c(this.props.translate,e.translate)&&c(this.props.scaleExtent,e.scaleExtent)&&this.props.zoom===e.zoom&&this.props.transitionDuration===e.transitionDuration||this.bindZoomListener(this.props),"function"==typeof this.props.onUpdate&&this.props.onUpdate({node:this.internalState.targetNode?d(this.internalState.targetNode):null,zoom:this.state.d3.scale,translate:this.state.d3.translate}),this.internalState.targetNode=null}setInitialTreeDepth(e,t){e.forEach(e=>{e._collapsed=e.depth>=t})}bindZoomListener(e){const{zoomable:t,scaleExtent:n,translate:s,zoom:i,onUpdate:r}=e,{rd3tSvgClassName:l,rd3tGClassName:d}=this.state,c=o("."+l),p=o("."+d);t&&c.call(a().scaleExtent([n.min,n.max]).on("zoom",e=>{p.attr("transform",`translate(${e.translate}) scale(${e.scale})`),"function"==typeof r&&(r({node:null,zoom:e.scale,translate:{x:e.translate[0],y:e.translate[1]}}),this.state.d3.scale=e.scale,this.state.d3.translate={x:e.translate[0],y:e.translate[1]})}).scale(i).translate([s.x,s.y]))}static assignInternalProperties(e){return(Array.isArray(e)?e:[e]).map(e=>(e.id=p.v4(),void 0===e._collapsed&&(e._collapsed=!1),e.children&&e.children.length>0&&(e.children=O.assignInternalProperties(e.children),e._children=e.children),e))}findNodesById(e,t,n){return n.length>0||(n=n.concat(t.filter(t=>t.id===e)),t.forEach(t=>{t._children&&t._children.length>0&&(n=this.findNodesById(e,t._children,n))})),n}findNodesAtDepth(e,t,n){return n=n.concat(t.filter(t=>t.depth===e)),t.forEach(t=>{t._children&&t._children.length>0&&(n=this.findNodesAtDepth(e,t._children,n))}),n}static collapseNode(e){e._collapsed=!0,e._children&&e._children.length>0&&e._children.forEach(e=>{O.collapseNode(e)})}static expandNode(e){e._collapsed=!1}collapseNeighborNodes(e,t){this.findNodesAtDepth(e.depth,t,[]).filter(t=>t.id!==e.id).forEach(e=>O.collapseNode(e))}generateTree(){const{initialDepth:e,useCollapseData:t,depthFactor:n,separation:o,nodeSize:s,orientation:a}=this.props,r=i.tree().nodeSize("horizontal"===a?[s.y,s.x]:[s.x,s.y]).separation((e,t)=>e.parent.id===t.parent.id?o.siblings:o.nonSiblings).children(e=>e._collapsed?null:e._children),l=this.state.data[0];let d=r.nodes(l);return!1===t&&void 0!==e&&this.internalState.initialRender&&(this.setInitialTreeDepth(d,e),d=r.nodes(l)),n&&d.forEach(e=>{e.y=e.depth*n}),{nodes:d,links:r.links(d)}}static calculateD3Geometry(e){let t;return t=e.zoom>e.scaleExtent.max?e.scaleExtent.max:e.zoom<e.scaleExtent.min?e.scaleExtent.min:e.zoom,{translate:e.translate,scale:t}}render(){const{nodes:t,links:n}=this.generateTree(),{rd3tSvgClassName:o,rd3tGClassName:s}=this.state,{nodeSvgShape:a,nodeLabelComponent:i,orientation:r,pathFunc:l,transitionDuration:d,zoomable:c,textLayout:h,nodeSize:y,depthFactor:f,initialDepth:O,separation:x,circleRadius:v,allowForeignObjects:D,styles:k}=this.props,{translate:C,scale:N}=this.state.d3,S=u({},y,x,{depthFactor:f,initialDepth:O});return e.createElement("div",{className:"rd3t-tree-container "+(c?"rd3t-grabbable":void 0)},e.createElement("svg",{className:o,width:"100%",height:"100%"},e.createElement(m,{transitionDuration:d,component:"g",className:s,transform:`translate(${C.x},${C.y}) scale(${N})`},n.map(t=>e.createElement(g,{key:p.v4(),orientation:r,pathFunc:l,linkData:t,onClick:this.handleOnLinkClickCb,onMouseOver:this.handleOnLinkMouseOverCb,onMouseOut:this.handleOnLinkMouseOutCb,transitionDuration:d,styles:k.links})),t.map(t=>e.createElement(b,{key:t.id,nodeSvgShape:u({},a,t.nodeSvgShape),nodeLabelComponent:i,nodeSize:y,orientation:r,transitionDuration:d,nodeData:t,name:t.name,attributes:t.attributes,onClick:this.handleNodeToggle,onMouseOver:this.handleOnMouseOverCb,onMouseOut:this.handleOnMouseOutCb,textLayout:t.textLayout||h,circleRadius:v,subscriptions:S,allowForeignObjects:D,styles:k.nodes})))))}}function x(e,t){const n={};return e.forEach(e=>{if(t){const n={};t.forEach(t=>{n[t]=e[t]}),e.attributes=n}var o;e.source=(n[o=e.parent]||(n[o]={name:o}),n[o]),e.target=((e,t)=>(n[e]||(n[e]={name:e,attributes:t}),n[e]))(e.child,e.attributes);const s=e.source,a=e.target;s.id=p.v4(),a.id=p.v4(),a.parent=s.name||null,s._collapsed=a._collapsed=!1,s._children?s._children.push(a):s._children=[a]}),[e.filter(e=>!e.source.parent)[0].source]}O.defaultProps={nodeSvgShape:{shape:"circle",shapeProps:{r:10}},nodeLabelComponent:null,onClick:void 0,onMouseOver:void 0,onMouseOut:void 0,onLinkClick:void 0,onLinkMouseOver:void 0,onLinkMouseOut:void 0,onUpdate:void 0,orientation:"horizontal",translate:{x:0,y:0},pathFunc:"diagonal",transitionDuration:500,depthFactor:void 0,collapsible:!0,useCollapseData:!1,initialDepth:void 0,zoomable:!0,zoom:1,scaleExtent:{min:.1,max:1},nodeSize:{x:140,y:140},separation:{siblings:1,nonSiblings:2},textLayout:{textAnchor:"start",x:10,y:-10,transform:void 0},allowForeignObjects:!1,shouldCollapseNeighborNodes:!1,circleRadius:void 0,styles:{}},O.propTypes={data:n.oneOfType([n.array,n.object]).isRequired,nodeSvgShape:n.shape({shape:n.string,shapeProps:n.object}),nodeLabelComponent:n.object,onClick:n.func,onMouseOver:n.func,onMouseOut:n.func,onLinkClick:n.func,onLinkMouseOver:n.func,onLinkMouseOut:n.func,onUpdate:n.func,orientation:n.oneOf(["horizontal","vertical"]),translate:n.shape({x:n.number,y:n.number}),pathFunc:n.oneOfType([n.oneOf(["diagonal","elbow","straight","step"]),n.func]),transitionDuration:n.number,depthFactor:n.number,collapsible:n.bool,useCollapseData:n.bool,initialDepth:n.number,zoomable:n.bool,zoom:n.number,scaleExtent:n.shape({min:n.number,max:n.number}),nodeSize:n.shape({x:n.number,y:n.number}),separation:n.shape({siblings:n.number,nonSiblings:n.number}),textLayout:n.object,allowForeignObjects:n.bool,shouldCollapseNeighborNodes:n.bool,circleRadius:n.number,styles:n.shape({nodes:n.object,links:n.object})},t(O);var v={__proto__:null,default:{parseCSV:function(e,t){return new Promise((n,o)=>{try{r(e,e=>n(x(e,t)))}catch(e){o(e)}})},parseJSON:function(e){return new Promise((t,n)=>{try{l(e,e=>t([e]))}catch(e){n(e)}})},parseFlatJSON:function(e,t){return new Promise((n,o)=>{try{l(e,e=>n(x(e,t)))}catch(e){o(e)}})},generateHierarchy:function(e){return x(e)}}};export{O as Tree,v as treeUtil};
//# sourceMappingURL=react-d3-tree.modern.js.map
